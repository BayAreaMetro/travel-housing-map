<html>
	<head>
		<title>MTC: Housing Prices Demo</title>
		<script type="text/javascript" src="lib/polymaps.min.js"></script>
		<script type="text/javascript" src="lib/jquery-1.5.min.js"></script>
		<script type="text/javascript" src="lib/timer.js"></script>
		<script type="text/javascript" src="lib/protovis-r3.2.js"></script>
		<script type="text/javascript" src="lib/utils.js"></script>
		<script type="text/javascript" defer="defer">
			$(function() {

				var po = org.polymaps,
						map = po.map()
							.container($("#map")[0].appendChild(po.svg("svg")));

				map.center({lon: -122.4194155, lat: 37.7749295})
				map.zoom(9);
				map.zoomRange([8, 12]);

				var taz = po.geoJson()
					.url(null)
					.tile(false)
					.zoom(map.zoom() + 2);

				var base = po.image()
					.url("http://a.acetate.geoiq.com/tiles/acetate-base/{Z}/{X}/{Y}.png");

				var labels = po.image()
					.url("http://a.acetate.geoiq.com/tiles/acetate-labels/{Z}/{X}/{Y}.png");

				map.add(base);
				map.add(taz);
				map.add(labels);
				map.add(po.interact());
				map.add(po.hash());

				$(labels.container())
					.css("pointer-events", "none");

				var scale = pv.Scale.linear()
					.domain(0, 250000, 1000000)
					.range("rgb(233,163,201)", "white", "rgb(161,215,106)");

				var threshold = 0;
				$("#update").bind("submit", update);

				function update() {
					threshold = parseFloat($("#price").val());
					// console.log("threshold: " + commize(threshold));
					var t = timer().start();
					taz.reshow();
					var took = t.end();
					$("#timer").text("(took " + took + "ms)");
					return false;
				}

				function price(feature) {
					return feature.properties.average_value_per_unit;
				}

				function formatPrice(p) {
					return "$" + commize(p);
				}

				var style = po.stylist();
				style.attr("stroke", "#999");
				style.attr("stroke-width", .5);
				style.title(function(feature) {
					return feature.properties["TAZ1454"] + ": " + formatPrice(price(feature));
				});

				style.attr("fill", function(feature) {
					if (price(feature) <= threshold) {
						var value = price(feature);
						var color = scale(value).color;
						// console.log(value + " -> " + color);
						return color;
					} else {
						return "#ccc";
					}
				});

				taz.on("show", style);

				$("#status").attr("class", "loading").text("Loading...");

				$.ajax("taz.js", {
					dataType: "jsonp",
					jsonpCallback: "loadTaz",
					error: function(req, text, e) {
						$("#status").attr("class", "error").text("Error: " + text);
					},
					success: function(collection) {

						var features = collection.features;

						var min = pv.min(features, price),
								median = pv.median(features, price),
								max = pv.max(features, price);

						scale.domain(min, median, max);

						$("#price").val(Math.round(median));
						$("#status").attr("class", "loaded").text("Loaded " + features.length + " TAZs; median: " + formatPrice(median));

						taz.features(features);
						update();
					}
				});

			});
		</script>
		<style type="text/css">
			html, body {
				width: 100%;
				height: 100%;
				margin: 0;
				padding: 0;
			}

			#map {
				width: 100%;
				height: 100%;
				position: relative;
				background: #999;
			}

			#controls {
				position: absolute;
				left: .5em;
				bottom: .5em;
				width: 24em;
				padding: .5em;
				background: #fff;
				border: 1px solid #666;
			}

			#controls p {
				margin: 0;
			}

			#timer {
				color: #999;
			}

			form {
				margin: 0;
			}

			#status {
				margin-top: .5em;
				color: #666;
			}

		</style>
	</head>
	<body>
		<div id="map">
			<div id="controls">
				<form id="update">
					<p>
						<label for="price">Max median housing price: <input id="price" value="100000"/></label>
						<input type="submit" value="update"/>
						<span id="timer"></span>
					</p>
				</form>
				<p id="status"></p>
			</div>
		</div>
	</body>
</html>
